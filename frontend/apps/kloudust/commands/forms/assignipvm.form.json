{
"id": "assignipvm",
"command": "assignIPToVM",
"type": "kloudust_cmdline",
"kloudust_cmdline_params": ["vm_name","ip","vnetlist"],

"title": "{{{i18n.VMAssignIPTitle}}}",

"i18n": {
    "en": {
        "VMAssignIPTitle": "Assign or unassign IP to a virtual machine",
        "VMAssignIPDescription": "Assign or unassign IP to a virtual machine on the cloud. Complete the required tab then submit.",
        "VMName": "Virtual machine name",
        "VMAssignIPCommand": "IP address to assign or unassign",
        "VMAssignIPCommandType": "Assignment type",
        "VMAssignIPAssign": "Assign",
        "VMAssignIPUnassign": "Unassign",
        "VMVNetListCommand" : "Select a VNet",
        "VMIPType": "IP Type",
        "VMIPTypePublic": "Public",
        "VMIPTypePrivate": "Private",
        "FieldValidationErrorGeneric": "Validation error"
    },
    "hi": {
        "VMAssignIPTitle": "Assign or unassign IP to a virtual machine",
        "VMAssignIPDescription": "Assign or unassign IP to a virtual machine on the cloud. Complete the required tab then submit.",
        "VMName": "वीएम नाम",
        "VMAssignIPCommand": "IP address to assign or unassign",
        "VMAssignIPCommandType": "Assignment type",
        "VMAssignIPAssign": "Assign",
        "VMAssignIPUnassign": "Unassign",
        "VMVNetListCommand" : "Select a VNet",
        "VMIPType": "IP Type",
        "VMIPTypePublic": "Public",
        "VMIPTypePrivate": "Private",
        "FieldValidationErrorGeneric": "Validation error"
    },
    "ja": {
        "VMAssignIPTitle": "Assign or unassign IP to a virtual machine",
        "VMAssignIPDescription": "Assign or unassign IP to a virtual machine on the cloud. Complete the required tab then submit.",
        "VMName": "VM名",
        "VMAssignIPCommand": "IP address to assign or unassign",
        "VMAssignIPCommandType": "Assignment type",
        "VMAssignIPAssign": "Assign",
        "VMAssignIPUnassign": "Unassign",
        "VMVNetListCommand" : "Select a VNet",
        "VMIPType": "IP Type",
        "VMIPTypePublic": "Public",
        "VMIPTypePrivate": "Private",
        "FieldValidationErrorGeneric": "Validation error"
    },
    "zh": {
        "VMAssignIPTitle": "Assign or unassign IP to a virtual machine",
        "VMAssignIPDescription": "Assign or unassign IP to a virtual machine on the cloud. Complete the required tab then submit.",
        "VMName": "虚拟机名称",
        "VMAssignIPCommand": "IP address to assign or unassign",
        "VMAssignIPCommandType": "Assignment type",
        "VMAssignIPAssign": "Assign",
        "VMAssignIPUnassign": "Unassign",
        "VMVNetListCommand" : "Select a VNet",
        "VMIPType": "IP Type",
        "VMIPTypePublic": "Public",
        "VMIPTypePrivate": "Private",
        "FieldValidationErrorGeneric": "Validation error"
    }
},

"form": {
    "description": "{{{i18n.VMAssignIPDescription}}}",

    "required_label": "{{{i18n.Required}}}",
    "required_fields": [
    {"id": "vm_name", "type": "text", "placeholder": "{{{i18n.VMName}}}", "required": true, 
        "pattern":"\\s[0-9a-zA-Z]+\\s", "validation_error": "{{{i18n.FieldValidationErrorGeneric}}}",
        "value":"{{{APP_CONSTANTS.ENV._vms_form_data.name_raw}}}", 
        "readonly":"{{#APP_CONSTANTS.ENV._vms_form_data.name_raw}}true{{/APP_CONSTANTS.ENV._vms_form_data.name_raw}}"},
    {"id": "iptype", "multioption": true, "type": "select", "label": "{{{i18n.VMIPType}}}", 
        "options":[
            {"value":"private", "label":"{{{i18n.VMIPTypePrivate}}}"}, 
            {"value":"public", "label":"{{{i18n.VMIPTypePublic}}}"}
        ]
    },
    {"id": "ip", "type": "text", "placeholder": "{{{i18n.VMAssignIPCommand}}}",
        "pattern":"^((25[0-5]|2[0-4][0-9]|1?[0-9]{1,2})\\.){3}(25[0-5]|2[0-4][0-9]|1?[0-9]{1,2})$", "validation_error": "{{{i18n.FieldValidationErrorGeneric}}}"},
    {"id": "iplist", "multioption": true, "type": "select", "label": "{{{i18n.VMAssignIPCommand}}}", "options":[]},
    {"id": "vnetlist", "multioption": true, "type": "select", "label": "{{{i18n.VMVNetListCommand}}}", "options":[]},
    {"id": "type", "multioption": true, "type": "select", "label": "{{{i18n.VMAssignIPCommandType}}}", 
        "options":[
            {"value":"assign", "label":"{{{i18n.VMAssignIPAssign}}}"}, 
            {"value":"unassign", "label":"{{{i18n.VMAssignIPUnassign}}}"}
        ]
    }
    ],

    "load_javascript": [
        "const form = arguments[0]||{};",
        "const vm_name = form.required_fields[0].value",
        "const vnetresult = await $$.libapimanager.rest(APP_CONSTANTS.API_KLOUDUSTCMD,",
        "'POST', { cmd: `getVMVnets ${vm_name}`, project: $$.libsession.get(APP_CONSTANTS.ACTIVE_PROJECT) }, true);",
        "if(vnetresult.result){",
        "   for(const vnet of vnetresult.vnets) {",
        "       const vnetlist = form.required_fields[form.required_fields.length-2];",
        "       vnetlist.options.push({value: vnet, label: vnet});",
        "   }",
        "} else form.required_fields[form.required_fields.length-2].options.push({value: 'novnetsfound', label: 'No Vnets Found'});",
        "const ipResults = await $$.libapimanager.rest(APP_CONSTANTS.API_KLOUDUSTCMD,",
        "'POST', { cmd: `listAssignedVMIPs ${vm_name}`, project: $$.libsession.get(APP_CONSTANTS.ACTIVE_PROJECT) }, true);",
        "if(ipResults.result){",
        "   for(const ip of ipResults.ips.split(',')) {",
        "       const iplist = form.required_fields[form.required_fields.length-3];",
        "       iplist.options.push({value: ip, label: ip});",
        "   }",
        "} else form.required_fields[form.required_fields.length-3].options.push({value: 'noipassigned', label: 'No IPs Assigned'});",
        "return form;"
    ],

    "rendered_javascript": [
        "const form = arguments[0], shadowroot = form._form_shadowroot;",
        "const selectElement = shadowroot.querySelector('select#type');",
        "const iptypeSelect = shadowroot.querySelector('select#iptype');",
        "const ipinput = shadowroot.querySelector('input#ip');",
        "const iplist = shadowroot.querySelector('select#iplist');",
        "const iplist_label = shadowroot.querySelector(\"label[for='iplist']\");",
        "const vnetlist = shadowroot.querySelector('select#vnetlist');",

        "const resetFields = () => {",
        "   iplist.style.display = 'none';",
        "   iplist_label.style.display = 'none';",
        "   vnetlist.style.display = 'none';",
        "   ipinput.style.display = 'none';",
        "};",

        "const updateFields = async () => {",
        "   resetFields();",
        "   const ipType = iptypeSelect.value;",
        "   const actionType = selectElement.value;",
        "   if (ipType === 'private') {",
        "       ipinput.style.display = 'block';",
        "       vnetlist.style.display = 'block';",
        "       return;",
        "   }",
        "   if (ipType === 'public' && actionType === 'unassign') {",
        "       iplist.style.display = 'block';",
        "       iplist_label.style.display = 'block';",
        "   }",
        "};",
        "iptypeSelect.addEventListener('change', updateFields);",
        "selectElement.addEventListener('change', updateFields);",
        "updateFields();",
        "return true;"
    ],

    "submitlabel": "{{{i18n.PowerOPVMSubmitLabel}}}",

    "submit_javascript": [
        "const retObject = arguments[0]||{};",
        "if (retObject.iptype == 'private' && retObject.type == 'assign') retObject._override_form_command='assignVnetIP';",
        "if (retObject.iptype == 'private' && retObject.type == 'unassign') retObject._override_form_command='unassignVnetIP';",
        "if (retObject.iptype == 'public') retObject.vnetlist = '';",
        "if (retObject.iptype == 'public' && retObject.type == 'assign') retObject.ip = '';",
        "if (retObject.iptype == 'public' && retObject.type == 'unassign') { retObject.ip = retObject.iplist; retObject._override_form_command='unassignIPToVM'; }",
        "return true;"
    ]
}

}
